<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Solar">
<meta property="og:url" content="https://zhangchenchen.github.io/page/9/index.html">
<meta property="og:site_name" content="Solar">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Solar">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhangchenchen.github.io/page/9/"/>





  <title> Solar </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-92407570-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Solar</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhangchenchen.github.io/2016/09/16/secure-your-ubuntu-server/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="pekingzcc">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Solar">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Solar" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/16/secure-your-ubuntu-server/" itemprop="url">
                  安全系列 --简单加固 ubuntu 服务器
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-16T15:01:55+08:00">
                2016-09-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/16/secure-your-ubuntu-server/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/16/secure-your-ubuntu-server/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p><a href="#A">前言 </a></p>
<p><a href="#B">花五分钟的时间加固 ubuntu server </a></p>
<p><a href="#C">其他</a></p>
<p><a name="A"></a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>逛v2ex的时候看到了一篇讨论 <a href="https://www.v2ex.com/t/306519#reply22" target="_blank" rel="noopener">在服务器上做什么加固策略</a>的帖子，想起自己之前看过的一篇文章，<a href="https://plusbryan.com/my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers" target="_blank" rel="noopener">My First 5 Minutes On A Server; Or, Essential Security for Linux Servers</a>，顺手写下这篇文章，权当记录，本篇的绝大部分内容都是出自这篇文章，强烈推荐，如果觉得TLDR,就接着往下翻吧。</p>
<p>安全，在大部分程序员潜意识里总是处于一种low priority的状态（参看此<a href="https://www.zhihu.com/question/20306241" target="_blank" rel="noopener">知乎链接</a>）。比如，我们搭建一个web server，会在第一时间去想用什么去部署，去实现，实现之后可能还会考虑高可用，可扩展等因素。而安全却总是会在最后才出现在我们的脑海里，甚至于直到出现安全事故才去关注。其实，我们拿到一台Linux服务器，只需要花些时间做一些安全方面的考量，做一些简单的措施就可以抵挡很大一部分攻击，提高攻击门槛。</p>
<p>那对于安全方面的措施，我比较推崇上文作者所说：简单有效。因为比较复杂的安全策略实施起来的增量收益可能会低于增加的大量人力物力资源。而且指不定还会引入其他的安全隐患。引用作者的话说：据我的经验来讲，大部分安全事故，要么是没有做足够的安全措施，要么是做了足够的安全措施，但没有更新维护导致出现漏洞。</p>
<p>Simplicity is the heart of good security.</p>
<p>下面就简单说下我们拿到一台服务器（或VPS）后需要做的一些安全加固措施。</p>
<p><a name="B"></a></p>
<h2 id="花五分钟的时间加固-ubuntu-server"><a href="#花五分钟的时间加固-ubuntu-server" class="headerlink" title="花五分钟的时间加固 ubuntu server"></a>花五分钟的时间加固 ubuntu server</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>本文中用的Linux发行版为 14.04。其他实验环境作者没有实践。<br>首先更改你的 root 密码为强类型密码。然后执行如下命令做一下升级：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get upgrade</span><br></pre></td></tr></table></figure>
<h3 id="尽量不要使用root用户"><a href="#尽量不要使用root用户" class="headerlink" title="尽量不要使用root用户"></a>尽量不要使用root用户</h3><p>新增一个用户，当需要root权限时再用sudo暂时提升权限。新建用户的密码也要是强类型密码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adduser example_user  <span class="comment">#新建 用户</span></span><br><span class="line">adduser example_user sudo  <span class="comment">#给新建用户添加sudo权限</span></span><br></pre></td></tr></table></figure>
<h3 id="使用SSH密钥认证登录"><a href="#使用SSH密钥认证登录" class="headerlink" title="使用SSH密钥认证登录"></a>使用SSH密钥认证登录</h3><p>利用ssh登录到Linux服务器有很多种方案，比较常用的就是用户名密码登录和SSH密钥认证的方式。<br>相对用户名密码登陆方式，后者是一种更安全的方案，因为前者容易受到暴力破解的威胁，而后者用暴力破解的方法不太实际。<br>首先需要在客户端产生公约密钥对。Linux下是如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>
<p>如果客户端是windows，可以利用putty等客户端实现。</p>
<p>创建完之后，我们会获取到两个文件，id_rsa.pub，和 id_rsa。也就是公钥文件和密钥文件。</p>
<p>接下来将公钥内容复制到服务器.ssh 目录下authorized_keys文件中。</p>
<h3 id="关闭SSH-密码服务器登陆"><a href="#关闭SSH-密码服务器登陆" class="headerlink" title="关闭SSH 密码服务器登陆"></a>关闭SSH 密码服务器登陆</h3><p>添加如下内容到 /etc/ssh/sshd_config 文件中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PermitRootLogin no</span><br><span class="line">PasswordAuthentication no</span><br><span class="line">AllowUsers deploy@(your-ip) deploy@(another-ip-if-any) # 添加允许登录IP</span><br></pre></td></tr></table></figure>
<p>重启ssh服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service ssh restart</span><br></pre></td></tr></table></figure>
<h3 id="添加防火墙"><a href="#添加防火墙" class="headerlink" title="添加防火墙"></a>添加防火墙</h3><p>添加防火墙有很多种方法，最简单的就是利用ubuntu 提供的ufw。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ufw allow from &#123;your-ip&#125; to any port 22 <span class="comment">#限定IP的端口</span></span><br><span class="line">ufw allow 80 <span class="comment">#打开80端口</span></span><br><span class="line">ufw allow 443 <span class="comment">#打开443端口</span></span><br><span class="line">ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure></p>
<p> 当然要根据你的实际要求来打开对应的端口。除了ufw，还有iptables,ip6tables,以及最新的nftables等都可以实现防火墙。</p>
<h3 id="安装Fail2ban"><a href="#安装Fail2ban" class="headerlink" title="安装Fail2ban"></a>安装Fail2ban</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install fail2ban</span><br></pre></td></tr></table></figure>
<p>Fail2ban 会在服务端扫描日志并根据一些策略屏蔽一些有可疑行为的用户（IP）。官方介绍说的比较清楚：</p>
<blockquote>
<p>Fail2ban scans log files (e.g. /var/log/apache/error_log) and bans IPs that show the malicious signs – too many password failures, seeking for exploits, etc. Generally Fail2Ban is then used to update firewall rules to reject the IP addresses for a specified amount of time, although any arbitrary other action (e.g. sending an email) could also be configured. Out of the box Fail2Ban comes with filters for various services (apache, courier, ssh, etc).<br> Fail2Ban is able to reduce the rate of incorrect authentications attempts however it cannot eliminate the risk that weak authentication presents. Configure services to use only two factor or public/private authentication mechanisms if you really want to protect services.</p>
</blockquote>
<h3 id="设置安全自动升级"><a href="#设置安全自动升级" class="headerlink" title="设置安全自动升级"></a>设置安全自动升级</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install unattended-upgrades</span><br><span class="line"></span><br><span class="line">vim /etc/apt/apt.conf.d/10periodic</span><br></pre></td></tr></table></figure>
<p>更新如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">APT::Periodic::Update-Package-Lists <span class="string">"1"</span>;</span><br><span class="line">APT::Periodic::Download-Upgradeable-Packages <span class="string">"1"</span>;</span><br><span class="line">APT::Periodic::AutocleanInterval <span class="string">"7"</span>;</span><br><span class="line">APT::Periodic::Unattended-Upgrade <span class="string">"1"</span>;</span><br></pre></td></tr></table></figure>
<p>再更新下这个文件/etc/apt/apt.conf.d/50unattended-upgrades</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> Unattended-Upgrade::Allowed-Origins &#123;</span><br><span class="line">        <span class="string">"Ubuntu lucid-security"</span>;</span><br><span class="line">//      <span class="string">"Ubuntu lucid-updates"</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="安装Logwatch"><a href="#安装Logwatch" class="headerlink" title="安装Logwatch"></a>安装Logwatch</h3><p>Logwatch 是一个强大的日志解析和分析软件。它被设计用来给出一台服务器上所有的活动报告，可以以命令行的形式输出，或邮件发送。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install logwatch</span><br><span class="line"></span><br><span class="line">vim /etc/cron.daily/00logwatch</span><br></pre></td></tr></table></figure>
<p> 添加如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/logwatch --output mail --mailto <span class="built_in">test</span>@gmail.com --detail high</span><br></pre></td></tr></table></figure>
<p><a name="C"></a></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>其实原文在<a href="https://news.ycombinator.com/item?id=5316093" target="_blank" rel="noopener">hacking news</a> 上引发了一系列的讨论。比如有人就提出，我们拿到一台服务器的时候，第一件事不是加固，而是应该先安装配置管理工具（Puppet or Chef），利用配置管理工具才更有条理。其实lz认为还是看实际场景吧，配置管理工具确实方便，尤其是对于一些大型的项目，而对于只搭一个blog的vps，确实没有必要。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://plusbryan.com/my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers" target="_blank" rel="noopener">My First 5 Minutes On A Server; Or, Essential Security for Linux Servers </a></p>
<p><a href="https://linode.com/docs/security/securing-your-server" target="_blank" rel="noopener">Securing Your Server</a></p>
<p><a href="https://news.ycombinator.com/item?id=5316093" target="_blank" rel="noopener">Hacking news</a></p>
<p><a href="https://www.v2ex.com/t/306519#reply22" target="_blank" rel="noopener">v2ex</a></p>
<p><strong><em>本篇文章由<a href="https://zhangchenchen.github.io/">pekingzcc</a>采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可,转载请注明。</em></strong></p>
<p> <strong><em>END</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhangchenchen.github.io/2016/09/06/openstack-cinder/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="pekingzcc">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Solar">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Solar" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/06/openstack-cinder/" itemprop="url">
                  openstack 系列 --cinder
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-06T15:01:55+08:00">
                2016-09-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/06/openstack-cinder/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/06/openstack-cinder/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>在学习一个新东西的时候，我们其实默认是带着问题去学习的。但当我们真正在卷帙繁多的互联网或者书籍里获取信息时。之前的问题往往就淡化了，反而更多的是跟着资料所给的思路去学习。这样有好处也有坏处，好处是我们不用费心去思考，而坏处也是如此，不用思考带来的后果就是这些信息虽然当时我们理解了，但很难在我们的脑海中建立知识图谱，比较容易遗忘。</p>
<p>所以以后我会在写文章的时候先把问题具象化，从自己问题的角度出发去寻找答案.</p>
<p>本篇我们的主题是openstack的块存储项目cinder,那么第一个问题自然是 <em>cinder是干什么用的？</em> 由这个问题出发，我们逐渐引出 <em>cinder如何实现？</em> ，<em>cinder的具体功能</em> 。</p>
<p><a href="#A">cinder是干什么用的 </a></p>
<p><a href="#B">cinder如何实现 </a></p>
<p><a href="#C">cinder的具体功能</a></p>
<p><a name="A"></a></p>
<h2 id="cinder是干什么用的"><a href="#cinder是干什么用的" class="headerlink" title="cinder是干什么用的"></a>cinder是干什么用的</h2><p>openstack中创建虚拟机的时候是附带一块硬盘的，但这块硬盘随着虚拟机的destroy也相应的删除了。所以，openstack推出了两种应付持久存储的解决方案，一个是之前我们提过的对象存储swift，一个就是现在我们讲的块存储cinder。<br>块存储,对象存储的概念我们<a href="http://zhangchenchen.github.io/2016/09/02/openstack-swift/">之前</a>已介绍过，不再赘述。<br><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160907openstack-storage-compare.jpg" alt="存储对比"><br>需要说明的是，cinder并不是新开发的一个块设备存储系统，它更像是一个资源管理系统，对不同的存储后端进行封装，以统一的API形式向虚拟机提供持久块存储资源。对于不同的存储后端，它采用插件的形式，结合不同的后端存储的驱动提供块存储服务。</p>
<p><a name="B"></a></p>
<h2 id="cinder如何实现"><a href="#cinder如何实现" class="headerlink" title="cinder如何实现"></a>cinder如何实现</h2><p>首先看一下cinder的主要组件：<br><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160907-openstack-cinder-part.jpg" alt="cinder architecture"><br>简单介绍下这几个组件：</p>
<ul>
<li><p>cinder-api: 负责接受和处理外界的API请求，并将请求放入RabbitMQ队列，交由其他程序执行。</p>
</li>
<li><p>cinder-scheduler: 在多个存储节点的情况下，新建或迁移volume的时候由该程序依据指定的算法选出合适的节点。算法有过滤算法和权重算法两种。</p>
</li>
<li><p>cinder-volume： 运行在存储节点上，管理存储空间，处理cinder数据库维护状态的读写请求，通过消息队列和直接在块存储设备或软件上与其他进程交互。每个存储节点都有一个Volume Service，若干个这样的存储节点联合起来可以构成一个存储资源池。cinder-volume为后端的volume provider 定义了统一的 driver 接口，volume provider 只需要实现这些接口，就可以 driver 的形式即插即用到 OpenStack 中。</p>
</li>
</ul>
<p>接下来介绍下这种插件机制以及后端的具体存储：<br>后端存储大致可以分为两类，一类是软件实现的存储系统，比如LVM,ceph,sheepdog等。另一类是商用的硬件支持的专业存储系统，比如IBM,HP,EMC等公司的专业存储系统。</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160907openstack-cinder-storage.jpg" alt="不同存储"></p>
<p>以LVM 为例：</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160907-cinder-lvm.jpg" alt="lvm"></p>
<p>此处简单介绍下iSCSI协议,引自 <a href="https://zh.wikipedia.org/wiki/ISCSI" target="_blank" rel="noopener">wiki</a>:</p>
<blockquote>
<p>iSCSI利用了TCP/IP的port 860 和 3260 作为沟通的渠道。透过两部计算机之间利用iSCSI的协议来交换SCSI命令，让计算机可以透过高速的局域网集线来把SAN模拟成为本地的储存装置。iSCSI使用 TCP/IP 协议（一般使用TCP端口860和3260）。 本质上，iSCSI 让两个主机通过 IP 网络相互协商然后交换 SCSI 命令。这样一来，iSCSI 就是用广域网仿真了一个常用的高性能本地存储总线，从而创建了一个存储局域网（SAN）。不像某些 SAN 协议，iSCSI 不需要专用的电缆；它可以在已有的交换和 IP 基础架构上运行。然而，如果不使用专用的网络或者子网（ LAN 或者 VLAN ），iSCSI SAN 的部署性能可能会严重下降。于是，iSCSI 常常被认为是光纤通道（Fiber Channel）的一个低成本替代方法，而光纤通道是需要专用的基础架构的。但是，基于以太网的光纤通道（FCoE）则不需要专用的基础架构。</p>
</blockquote>
<p>其他商用存储系统：</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160907-cinder-other%20-storage.jpg" alt="others"></p>
<p>两者对比，<a href="chrome-extension://ikhdkkncnoglghljlkmcimlnlhkeamad/pdf-viewer/web/viewer.html?file=https%3A%2F%2Fevents.linuxfoundation.org%2Fsites%2Fevents%2Ffiles%2Fslides%2FCloudOpenJapan2014-Kimura_0.pdf" target="_blank" rel="noopener">check this!</a></p>
<p><a name="C"></a></p>
<h2 id="cinder的具体功能"><a href="#cinder的具体功能" class="headerlink" title="cinder的具体功能"></a>cinder的具体功能</h2><p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160907-cinder-functure.jpg" alt="cinder functure"></p>
<p>从代码层面了解具体实现的流程，<a href="https://www.ibm.com/developerworks/community/blogs/132cfa78-44b0-4376-85d0-d3096cd30d3f/entry/Create_Volume_%E6%93%8D%E4%BD%9C_Part_III_%E6%AF%8F%E5%A4%A95%E5%88%86%E9%92%9F%E7%8E%A9%E8%BD%AC_OpenStack_52?lang=en" target="_blank" rel="noopener">check this!</a></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://www.cnblogs.com/sammyliu/p/4219974.html" target="_blank" rel="noopener">探索 OpenStack 之（9）：深入块存储服务Cinder </a></p>
<p><a href="https://www.ibm.com/developerworks/community/blogs/132cfa78-44b0-4376-85d0-d3096cd30d3f/entry/%E7%90%86%E8%A7%A3_Cinder_%E6%9E%B6%E6%9E%84_%E6%AF%8F%E5%A4%A95%E5%88%86%E9%92%9F%E7%8E%A9%E8%BD%AC_OpenStack_45?lang=en" target="_blank" rel="noopener">每天五分钟玩转openstack </a></p>
<p><a href="https://book.douban.com/subject/26374647/" target="_blank" rel="noopener">openstack 设计与实现</a></p>
<p><strong><em>本篇文章由<a href="https://zhangchenchen.github.io/">pekingzcc</a>采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可,转载请注明。</em></strong></p>
<p> <strong><em>END</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhangchenchen.github.io/2016/09/05/python-web-intro/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="pekingzcc">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Solar">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Solar" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/05/python-web-intro/" itemprop="url">
                  python系列--python web 运行与部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-05T14:58:25+08:00">
                2016-09-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/05/python-web-intro/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/05/python-web-intro/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录结构："><a href="#目录结构：" class="headerlink" title="目录结构："></a>目录结构：</h2><p>在学习一个新东西的时候，我们其实默认是带着问题去学习的。但当我们真正在卷帙繁多的互联网或者书籍里获取信息时。之前的问题往往就淡化了，反而更多的是跟着资料所给的思路去学习。这样有好处也有坏处，好处是我们不用费心去思考，而坏处也是如此，不用思考带来的后果就是这些信息虽然当时我们理解了，但很难在我们的脑海中建立知识图谱，比较容易遗忘。</p>
<p>所以以后我会在写文章的时候先把问题具象化，从自己问题的角度出发去寻找答案。</p>
<p>本篇我们的问题从 <em>python web 是如何跑起来的？</em> 开始，一步步探究由此问题引起的其他内容。</p>
<p><a href="#A">python web 是如何跑起来的？ </a></p>
<p><a href="#B">探究 WSGI </a></p>
<p><a href="#C">探究 python web framework</a></p>
<p><a href="#D">探究 python web server</a></p>
<p><a href="#E">常见 python web生产部署环境</a></p>
<p><a name="A"></a></p>
<h2 id="python-web-是如何跑起来的？"><a href="#python-web-是如何跑起来的？" class="headerlink" title="python web 是如何跑起来的？"></a>python web 是如何跑起来的？</h2><p>要知道python web 是如何跑起来的，我们首先要知道一个http请求的生命周期。<br>一个http请求从浏览器发出，在服务端被http server接收，这个http server对请求进行解析，如果是一些图片，文本等静态资源，它就会根据路径去寻找对应的资源并返回。如果是请求的动态资源，比如jsp/php等，它就会把相应的http请求转发给一个web server,由web server对请求进行解析并处理，并最终返回一个 http response。这就是一个http请求的大致周期。<br>接下来对应到python web中，当web server 接收到一个请求时，它当然是解析请求并把该请求映射到我们写的对应的处理逻辑中。我们的处理逻辑处理完成后，再将结果由web server 转发出去。那web werver 与 我们写的处理逻辑该怎样做才能实现上述效果呢，这就引出了 WSGI。</p>
<p><em>以下示例摘自<a href="http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001386832689740b04430a98f614b6da89da2157ea3efe2000" target="_blank" rel="noopener">廖雪峰的官方网站</a></em></p>
<p>WSGI:Web Server Gateway Interface.<br>WSGI接口定义非常简单，它只要求Web开发者实现一个函数，就可以响应HTTP请求。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hello.py</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></span><br><span class="line">    start_response(<span class="string">'200 OK'</span>, [(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>)])</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h1&gt;Hello, web!&lt;/h1&gt;'</span></span><br></pre></td></tr></table></figure>
<p>以上代码中application 函数接收两个参数，environ是一个包含所有HTTP请求信息的dict对象，start_response是一个发送HTTP响应的函数，该函数就是符合WSGI标准的一个HTTP处理函数。调用start_response()就发送了一个http header, http body 就是下文return 的数据。<br>利用python自带的 web server 加载上面这个application.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.py</span></span><br><span class="line"><span class="comment"># 从wsgiref模块导入:</span></span><br><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"><span class="comment"># 导入我们自己编写的application函数:</span></span><br><span class="line"><span class="keyword">from</span> hello <span class="keyword">import</span> application</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个服务器，IP地址为空，端口是8000，处理函数是application:</span></span><br><span class="line">httpd = make_server(<span class="string">''</span>, <span class="number">8000</span>, application)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Serving HTTP on port 8000..."</span></span><br><span class="line"><span class="comment"># 开始监听HTTP请求:</span></span><br><span class="line">httpd.serve_forever()</span><br></pre></td></tr></table></figure>
<p>确保以上两个文件在同一个目录下，然后在命令行输入python server.py来启动WSGI服务器。</p>
<p><a name="B"></a></p>
<h2 id="探究-WSGI"><a href="#探究-WSGI" class="headerlink" title="探究 WSGI"></a>探究 WSGI</h2><p><em>以下内容摘自<a href="https://gist.github.com/nature-python/8954123" target="_blank" rel="noopener">wsgi和tornado.md</a></em></p>
<p>WSGI是为python语言定义的web服务器和web应用程序或框架之间的一种简单而实用的接口。wsgi是一个web组件的接口规范，它将web组件分为三类：server，middleware，application。接下来简单介绍下这三个组件：</p>
<ul>
<li>wsgi server :可以理解为一个符合wsgi规范的web server，接收request请求，封装一系列环境变量，按照wsgi规范调用注册的wsgi app，最后将response返回给客户端。</li>
<li>wsgi application :就是一个普通的callable对象，当有请求到来时，wsgi server会调用这个wsgi app。这个对象接收两个参数，通常为environ,start_response。environ可以理解为环境变量，跟一次请求相关的所有信息都保存在了这个环境变量中，包括服务器信息，客户端信息，请求信息。start_response是一个callback函数，wsgi application通过调用start_response，将response headers/status 返回给wsgi server。此外这个wsgi app会return 一个iterator对象 ，这个iterator就是response body。</li>
<li>wsgi middleware :可以简单地理解为对application的封装。通过封装实现一些公用的功能，如下示例用一个简单Dispatcher Middleware，用来实现URL 路由：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</span><br><span class="line"></span><br><span class="line">URL_PATTERNS= (</span><br><span class="line">    (<span class="string">'hi/'</span>,<span class="string">'say_hi'</span>),</span><br><span class="line">    (<span class="string">'hello/'</span>,<span class="string">'say_hello'</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_match</span><span class="params">(self,path)</span>:</span></span><br><span class="line">        path = path.split(<span class="string">'/'</span>)[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">for</span> url,app <span class="keyword">in</span> URL_PATTERNS:</span><br><span class="line">            <span class="keyword">if</span> path <span class="keyword">in</span> url:</span><br><span class="line">                <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self,environ, start_response)</span>:</span></span><br><span class="line">        path = environ.get(<span class="string">'PATH_INFO'</span>,<span class="string">'/'</span>)</span><br><span class="line">        app = self._match(path)</span><br><span class="line">        <span class="keyword">if</span> app :</span><br><span class="line">            app = globals()[app]</span><br><span class="line">            <span class="keyword">return</span> app(environ, start_response)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            start_response(<span class="string">"404 NOT FOUND"</span>,[(<span class="string">'Content-type'</span>, <span class="string">'text/plain'</span>)])</span><br><span class="line">            <span class="keyword">return</span> [<span class="string">"Page dose not exists!"</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hi</span><span class="params">(environ, start_response)</span>:</span></span><br><span class="line">    start_response(<span class="string">"200 OK"</span>,[(<span class="string">'Content-type'</span>, <span class="string">'text/html'</span>)])</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">"kenshin say hi to you!"</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say_hello</span><span class="params">(environ, start_response)</span>:</span></span><br><span class="line">    start_response(<span class="string">"200 OK"</span>,[(<span class="string">'Content-type'</span>, <span class="string">'text/html'</span>)])</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">"kenshin say hello to you!"</span>]</span><br><span class="line"></span><br><span class="line">app = Dispatcher()</span><br><span class="line"></span><br><span class="line">httpd = make_server(<span class="string">''</span>, <span class="number">8000</span>, app)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Serving on port 8000..."</span></span><br><span class="line">httpd.serve_forever()</span><br></pre></td></tr></table></figure>
<p>以上代码就已经有点web framework 的意思啦。由这个实例我们可以看到写一个基于wsgi的python web framework其实就是实现wsgi application部分和wsgi middleware 部分。其实，写一个python web framework 也是一件非常简单的事，见<a href="http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/0014023080708565bc89d6ab886481fb25a16cdc3b773f0000" target="_blank" rel="noopener">廖雪峰的官方博客</a>。下面我们就探究一下业界常用的python web framework。而wsgi server部分我们待会再谈。</p>
<p><a name="C"></a></p>
<h2 id="探究-python-web-framework"><a href="#探究-python-web-framework" class="headerlink" title="探究 python web framework"></a>探究 python web framework</h2><p>翻看python 的wiki，我们发现关于python的web framework 以井喷的速度发展，各式各样的框架。截两张图，分别是主流的全栈框架和非全栈框架：</p>
<p>主流的全栈python web框架:<br><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160905python-full-stack.jpg" alt="full-stack"></p>
<p>这里要多说一句tornado框架，其实它不单是一个web框架，还是一个web服务器。作为Web框架，是一个轻量级的Web框架，类似于另一个Python web 框架Web.py，其拥有异步非阻塞IO的处理方式。作为Web服务器，Tornado有较为出色的抗负载能力，官方用nginx反向代理的方式部署Tornado和其它Python web应用框架进行对比，结果最大浏览量超过第二名近40%。见下表：<br><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160905tornado%20awesome.jpg" alt="tornado 比较"></p>
<p>主流的非全栈python web框架：<br><img src="http://7xrnwq.com1.z0.glb.clouddn.com/2016-0905python-non-full-stack.jpg" alt="non-full-stack"></p>
<p><a name="C"></a></p>
<h2 id="探究-python-web-server"><a href="#探究-python-web-server" class="headerlink" title="探究 python web server"></a>探究 python web server</h2><ul>
<li><p>Apache + modwsgi，配置安装比较繁琐，用的人越来越少。</p>
</li>
<li><p>Gunicorn，运行在UNIX平台上的python wsgi http server。</p>
</li>
<li><p>uWSGI,实现了uwsgi和WSGI两种协议的Web服务器，负责响应python 的web请求。此处提醒一下，uwsgi是一种uWSGI服务器自有的协议，它跟WSGI毛的关系都没有。关于他们的区别，<a href="http://www.itopers.com:8080/?p=586" target="_blank" rel="noopener">看这</a></p>
</li>
<li><p>Tornado,上文已介绍。</p>
</li>
</ul>
<p>附录一张图：<br><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160905-test-cgi-glue.png" alt="test"></p>
<p><a name="D"></a></p>
<h2 id="常见-python-web生产部署环境"><a href="#常见-python-web生产部署环境" class="headerlink" title="常见 python web生产部署环境"></a>常见 python web生产部署环境</h2><p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160905python-web-deploy.jpg" alt="python web deploy"></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001386832689740b04430a98f614b6da89da2157ea3efe2000" target="_blank" rel="noopener">廖雪峰的官方网站</a></p>
<p><a href="https://www.zhihu.com/question/21888077" target="_blank" rel="noopener">大家都是怎么部署python网站的</a></p>
<p><a href="http://www.itopers.com:8080/?p=586" target="_blank" rel="noopener">区分wsgi、uWSGI、uwsgi、php-fpm、CGI、FastCGI的概念</a></p>
<p><a href="https://www.zhihu.com/question/30560394" target="_blank" rel="noopener">使用了Gunicorn或者uWSGI,为什么还需要Nginx？</a></p>
<p><a href="https://www.peterbe.com/plog/fcgi-vs-gunicorn-vs-uwsgi" target="_blank" rel="noopener">fcgi vs. gunicorn vs. uWSGI</a></p>
<p><a href="http://stackoverflow.com/questions/11811434/what-is-the-difference-between-uwsgi-protocol-and-wsgi-protocol" target="_blank" rel="noopener">What is the difference between uwsgi protocol and wsgi protocol?</a></p>
<p><a href="http://www.letiantian.me/2015-09-10-understand-python-wsgi/" target="_blank" rel="noopener">理解Python WSGI</a></p>
<p><a href="https://wiki.python.org/moin/WebFrameworks" target="_blank" rel="noopener">Web Frameworks for Python</a></p>
<p><strong><em>本篇文章由<a href="https://zhangchenchen.github.io/">pekingzcc</a>采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可,转载请注明。</em></strong></p>
<p> <strong><em>END</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhangchenchen.github.io/2016/09/02/openstack-swift/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="pekingzcc">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Solar">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Solar" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/02/openstack-swift/" itemprop="url">
                  openstack系列--swift
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-02T14:24:25+08:00">
                2016-09-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/02/openstack-swift/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/02/openstack-swift/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录结构："><a href="#目录结构：" class="headerlink" title="目录结构："></a>目录结构：</h2><p>在学习一个新东西的时候，我们其实默认是带着问题去学习的。但当我们真正在卷帙繁多的互联网或者书籍里获取信息时。之前的问题往往就淡化了，反而更多的是跟着资料所给的思路去学习。这样有好处也有坏处，好处是我们不用费心去思考，而坏处也是如此，不用思考带来的后果就是这些信息虽然当时我们理解了，但很难在我们的脑海中建立知识图谱，比较容易遗忘。</p>
<p>所以以后我会在写文章的时候先把问题具象化，从自己问题的角度出发去寻找答案。比如本篇我们学习openstack的对象存储模块swift，出现在脑海中的第一个问题就是 <em>swift 是做什么用的？</em> 在解决了这个问题以后，我们知道<br>是做对象存储的，那么， <em>它是如何进行存储的？</em> ，这就是第二个问题。在了解了它的存储机制后，我们还想问的就是 <em>既然是存储，那么它的安全性机制是怎么做的？数据丢失了怎么办？</em> 。最后我们就要了解下 <em>swift 的具体使用</em> 以及 深入到代码层面 <em>源码的组织架构</em> 等。</p>
<p><a href="#A">swift什么用？ </a></p>
<p><a href="#B">swift中数据如何存储？ </a></p>
<p><a href="#C">swift中的安全机制</a></p>
<p><a href="#D">swift 如何使用？</a></p>
<p><a href="#E">swift 源码目录结构</a></p>
<p><a name="A"></a></p>
<h2 id="swift-什么用？"><a href="#swift-什么用？" class="headerlink" title="swift 什么用？"></a>swift 什么用？</h2><p>我们已经知道swift是openstack中负责对象存储的组件。自然而然的引出另一个问题，什么是对象存储？除了对象存储还有其他什么类型的存储，区别是什么？OK，接下来慢慢解决这些问题。</p>
<p>对象存储，有点类似于hashmap这种数据结构，我们可以通过key来获取/删除对应的value值。对象存储就是将对象数据作为一个逻辑单元存储起来，更多的操作是获取，删除。更新操作频率比较低。相应的，对象存储比较适合于存放静态数据或者更新频率比较低的大容量数据。比如一些多媒体数据，数据备份，虚拟机镜像等。</p>
<p>其他的存储类型还包括块存储，文件存储。</p>
<p>块存储通常提供的原始块设备，就是裸磁盘空间，比如磁盘阵列里面有2块硬盘，然后可以通过划逻辑盘、做Raid、或者LVM（逻辑卷）等种种方式逻辑划分出N个逻辑的硬盘，再采用映射的方式将这几个逻辑盘映射给主机使用。一些对实时性要求比较高的存储我们就得用块存储了，比如数据库。openstack中对应的组件为cinder。</p>
<p>文件存储就比较好理解了，我们常用的Windows操作系统就搭载了一套文件系统，提供文件存储。在分布式环境中，常用NFS协议，通过TCP/IP实现网络化存储，比如我们常用的NFS或者FTP服务器。</p>
<p><a name="B"></a></p>
<h2 id="swift中数据如何存储？"><a href="#swift中数据如何存储？" class="headerlink" title="swift中数据如何存储？"></a>swift中数据如何存储？</h2><p>首先看下swift的整体架构：</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160902-swift_architecture.jpg" alt="swift_arvhitecture"></p>
<p>整体架构主要分为两部分，访问层（Access Tier）和存储层（Storage Node）。访问层最主要的有两部分，Proxy node 主要负责Http请求的的转发，还有一个负责用户身份的认证（Authentication）。可选的是一个负载均衡设备。</p>
<p>当一个Restful请求到来时，Proxy node 负责接受用户请求并转发给认证服务进行处理，认证通过后再转发给存储层进行数据的操作。在转发给存储层之前，如果启用缓存的话，首先会去缓存服务器检查是否命中，命中就不用去数据层了。</p>
<p>接下来我们看下存储层，存储层由一系列的存储节点组成。为了便于组织以及故障隔离，这些存储节点在物理上做了一些划分，比如根据地理位置的不同划分region,一个 region相当于一个数据中心，每个rigion内部有多个zone，zone可以理解为一组独立的存储节点。一个zone包含多个存储节点（storage node）,一个node里有多个Device(可以理解为磁盘)，一个Device包含多个Partition(可以理解为磁盘中文件系统上的一个目录)。</p>
<p>在每个Storage node 上存储的对象在逻辑上又分为三层：</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160902swift-object-acchitectture.png" alt="swift 对象组织架构"></p>
<p>相应的，Storage node 中运行着三种对应的服务：</p>
<ul>
<li>Account Server :Account server 负责Account相关的一些服务，比如包含的Countainer列表，以及Account的元数据等。这些数据存储在一个SQLLite数据库中。</li>
<li>Countainer Server : 负责Countainer相关服务，比如包含的object列表，Countainer元数据。也存储在SQLlite数据库中。</li>
<li>Object Server : 提供对象数据的存取及相应的元数据服务，以二进制的形式存储在存储节点中，元数据以扩展属性的形式存储其中。因为对应的存储系统必须支持文件的扩展属性。</li>
</ul>
<p>由以上信息我们得知swift对象最终以二进制的形式存储在存储节点中，存储节点中并没有“路径”的概念，那么它最终是如何与物理位置映射的呢？swift提出了ring的概念，ring其实就是记录了存储对象与物理存储节点的映射关系，object，countainer，account都有与之对应的ring。proxy server接收到http请求时，先查找操作实体（object，countainer，account）对应的ring,根据ring确定他们在对应的服务器集群中的具体位置，并将对应的http请求转发给对应的节点上的server。</p>
<p>此处注意的是，对象寻址并非是渐进式的（即寻找某个object先寻找account，再寻找下面的countainer,再寻找对应的object），而是直接寻找（即寻找object ,直接ring就可以找到，同理寻找某个account，countainer也是如此）。</p>
<p>为什么叫ring呢？其实这跟那个映射算法有关，这个将数据映射在相应服务器集群上某个节点的算法叫一致性hash算法，关于该算法，可以花5分钟的时间了解下<a href="http://blog.csdn.net/cywosp/article/details/23397179" target="_blank" rel="noopener">这篇文章</a></p>
<p>至于swift 中是如何具体实现该算法的就不详细叙述了。下图为大致架构图：</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160904-openstack-swift-logic-architecture.png" alt="openstack-swift-logic-architecture"></p>
<p><a name="C"></a></p>
<h2 id="swift中的安全机制"><a href="#swift中的安全机制" class="headerlink" title="swift中的安全机制"></a>swift中的安全机制</h2><p>swift 中为了保证数据在损坏的情况下依然保证高可用，采用了增加副本的策略，每一个对象都会有若干个备份的副本（默认是三个），且存储在不同的zone里，这样，当某一个zone的对象数据不可用时，还可以启用其他zone里的副本。这样为了解决数据一致性的问题，swift开启了以下三个服务：</p>
<ul>
<li><p>Replicator: 负责检查数据与相应副本是否一致。如果出现数据不一致的情况，会将过时的数据更新，并负责将标记为删除的数据从磁盘上删除。</p>
</li>
<li><p>Auditor: 持续扫描磁盘检查Acount,Container和object数据的完整性，如果发现数据损坏，就会对相应的数据隔离，然后通过Replicator从其他节点上获取副本以恢复。</p>
</li>
<li><p>Updator: 在创建一个object的时候，需要对应的更新该object所在的container列表，以及再上层的account 列表，同理，创建container的时候也是如此。有时候这些更新操作因为相应的server繁忙而更新失败，swift会使用Updator服务继续处理这些失败的更新操作。</p>
</li>
</ul>
<p><a name="D"></a></p>
<h2 id="swift的使用"><a href="#swift的使用" class="headerlink" title="swift的使用"></a>swift的使用</h2><p>swift的使用跟其他openstack的组件使用一样都是通过restful API来提供服务。swift API主要提供了以下几种功能：</p>
<ul>
<li>对象存储 单个对象默认最大值是5GB，可以用户自己配置。</li>
<li>超过最大值对象的数据可以通过中间件进行上传，存储</li>
<li>对象压缩</li>
<li>对象删除</li>
</ul>
<p>swift API 的执行过程大致如下：swiftClient 将用户的命令转换为标准HTTP请求（如果是用户请求本身就是HTTP请求那么没有这一步）;paste deploy将请求路由到proxy-server WSGI Application;根据请求内容调用对应的Controller(AccountController,ContainerController或者ObjectController),该controller会将请求转发到特定的存储节点上的WSGI Server(Account Server,Container Server或Object Server);这些server接收到http请求并处理。</p>
<p><a name="E"></a></p>
<h2 id="swift-源码目录结构"><a href="#swift-源码目录结构" class="headerlink" title="swift 源码目录结构"></a>swift 源码目录结构</h2><p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160904-openstack-swift-sourcecode.jpg" alt="swift source code"></p>
<ul>
<li>bin: 主要是一些启动脚本，工具脚本。比如proxy-server负责启动proxy server，swift-ring-builder 用来创建ring。</li>
<li>swift：swift的核心代码。其子目录account,container,obj,proxy分别对应相应的服务的具体实现。common子目录是被多个组件共用的公共代码。</li>
<li>etc:配置文件模板</li>
</ul>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://book.douban.com/subject/26374647/" target="_blank" rel="noopener">openstack 设计与实现</a></p>
<p><a href="http://blog.csdn.net/cywosp/article/details/23397179" target="_blank" rel="noopener">五分钟了解一致性hash</a></p>
<p><a href="https://github.com/openstack/swift" target="_blank" rel="noopener">swift github</a></p>
<p><strong><em>本篇文章由<a href="https://zhangchenchen.github.io/">pekingzcc</a>采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可,转载请注明。</em></strong></p>
<p> <strong><em>END</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhangchenchen.github.io/2016/08/31/python-requests/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="pekingzcc">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Solar">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Solar" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/31/python-requests/" itemprop="url">
                  python库系列--requests 与 刷票
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-31T10:24:25+08:00">
                2016-08-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/31/python-requests/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/31/python-requests/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录结构："><a href="#目录结构：" class="headerlink" title="目录结构："></a>目录结构：</h2><p><a href="#A">关于刷票的若干思考 </a></p>
<p><a href="#B">requests 引出 </a></p>
<p><a href="#C">requests 基本用法</a></p>
<p><a href="#D">requests 高级用法</a></p>
<p><a name="A"></a></p>
<h2 id="关于刷票的若干思考"><a href="#关于刷票的若干思考" class="headerlink" title="关于刷票的若干思考"></a>关于刷票的若干思考</h2><p>前两天同学让我帮他去一个网站帮他刷票，就顺手写了一个小程序，整理一下关于刷票的若干思考：<br>其实应付普通的投票机制非常简单，只要懂点http的相关知识就可以搞定，原理就是构造相应的HTTP请求。一般来说，为了防止刷票，都会有以下几种防刷票策略：</p>
<ul>
<li><p>限制IP : 相应的对策就是伪造IP。要想伪造IP的话首先要知道后端服务器程序是怎么获取IP的。至少有三个HTTP HEAD可以获取用户端IP，REMOTE_ADDR、HTTP_VIA、HTTP_FORWARDED_FOR 。REMOTE_ADDR是WEB服务器获取的用户IP值，也就是最终的外网IP，但它的重复值太多，所以不能作为唯一判断标志。 HTTP_VIA是倒数第二个代理服务器/网关的IP。 HTTP_FORWARDED_FOR是所有网关和你自己的IP列表。大部分服务端程序都是用HTTP_FORWARDED_FOR来获取IP。这样我们就可以通过修改HTTP_FORWARDED_FOR来达到伪造IP的目的。</p>
</li>
<li><p>限制网页来源 : 修改 http header中的refer。</p>
</li>
<li><p>限制 user-agent : 修改 http header中的 user-agent。</p>
</li>
<li><p>限制cookie : 修改 http header中的 cookie</p>
</li>
<li><p>限制登录后才可以投票 :模拟登录</p>
</li>
<li><p>验证码验证 : 简单的验证码可以通过OCR识别技术，增加干扰策略的验证码就比较复杂了，不予讨论。</p>
</li>
</ul>
<p>当然，其实防刷票机制不只是上面简单的几种，一般来说比较安全的网站都会制定一些策略，比如IP可疑就增加验证码难度，设定黑白名单等。</p>
<p><a name="B"></a></p>
<h2 id="requests-引出"><a href="#requests-引出" class="headerlink" title="requests 引出"></a>requests 引出</h2><p>因为写上面的那个小程序用的是requests库。就简单的学习了一下这个库。<br>python有自己的标准网络库，urllib,urllib2。但这两个库用着都不是特别的顺畅，requests 库的出现让人们眼前一亮，官网的declare:HTTP for Humans 。强调人性化。</p>
<p><a name="C"></a></p>
<h2 id="requests-基本用法"><a href="#requests-基本用法" class="headerlink" title="requests 基本用法"></a>requests 基本用法</h2><p>requests包要完成的内容无非就是发送和接收http请求。接下来我们就从发送请求和接收请求两方面讨论下它的基本使用。</p>
<ul>
<li>发送请求 ：首先最简单的就是常用的get，post等发送HTTP请求类型，requests是这样发送的：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">r = requests.get(<span class="string">'https://github.com/timeline.json'</span>)</span><br><span class="line">r = requests.post(<span class="string">"http://httpbin.org/post"</span>)</span><br><span class="line">r = requests.put(<span class="string">"http://httpbin.org/put"</span>)</span><br><span class="line">r = requests.delete(<span class="string">"http://httpbin.org/delete"</span>)</span><br><span class="line">r = requests.head(<span class="string">"http://httpbin.org/get"</span>)</span><br><span class="line">r = requests.options(<span class="string">"http://httpbin.org/get"</span>)</span><br></pre></td></tr></table></figure>
<p> 对于 get 请求，我们可以通过添加params添加关键字参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">param = &#123;<span class="string">'key1'</span>: <span class="string">'value1'</span>, <span class="string">'key2'</span>: <span class="string">'value2'</span>&#125;</span><br><span class="line">r = requests.get(<span class="string">"http://httpbin.org/get"</span>, params=param)</span><br></pre></td></tr></table></figure>
<p> 对于post请求，我们可以通过data参数来模拟提交表单。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">param = &#123;<span class="string">'key1'</span>: <span class="string">'value1'</span>, <span class="string">'key2'</span>: <span class="string">'value2'</span>&#125;</span><br><span class="line">r = requests.get(<span class="string">"http://httpbin.org/get"</span>, data=param)</span><br></pre></td></tr></table></figure>
<p> 还可以通过 headers参数定制我们发送的请求：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"> my_headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span> : <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.116 Safari/537.36'</span>,</span><br><span class="line">    <span class="string">'Accept'</span> : <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Accept-Encoding'</span> : <span class="string">'gzip'</span>,</span><br><span class="line">    <span class="string">'Accept-Language'</span> : <span class="string">'zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4'</span></span><br><span class="line">&#125;</span><br><span class="line"> r = requests.get(<span class="string">"http://httpbin.org/get"</span>, headers=my_headers)</span><br></pre></td></tr></table></figure>
<p> 除此之外，还有timeout，cookies参数来设置响应时间，cookie。</p>
<ul>
<li>相应内容 ： 任何时候调用 requests.*() 你都在做两件主要的事情。其一，你在构建一个 Request 对象， 该对象将被发送到某个服务器请求或查询一些资源。其二，一旦requests得到一个从服务器返回的响应就会产生一个 Response 对象。该响应对象包含服务器返回的所有信息， 也包含你原来创建的 Request 对象。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">r = requests.get(<span class="string">'https://github.com/timeline.json'</span>)</span><br><span class="line"></span><br><span class="line">print(r.text) <span class="comment"># 字符形式，可以自己设置编码</span></span><br><span class="line"></span><br><span class="line">print(r.content) <span class="comment"># 二进制形式</span></span><br><span class="line"></span><br><span class="line">print(r.json()) <span class="comment"># json形式,requests 中有一个内置的 JSON 解码器,处理 JSON 数据。</span></span><br><span class="line"></span><br><span class="line">print(r.raw()) <span class="comment"># 原始套接字形式</span></span><br></pre></td></tr></table></figure>
<p><a name="D"></a></p>
<h2 id="高级用法"><a href="#高级用法" class="headerlink" title="高级用法"></a>高级用法</h2><ul>
<li>会话对象：http是无状态的，为了能够获取用户登录状态，一般服务器会用一个sessionId放在cookie中。用户发送的请求也包含这个sessionId，这些工作由浏览器来做。而requests也实现了类似功能。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line">s.get(<span class="string">'http://httpbin.org/cookies/set/sessioncookie/123456789'</span>)</span><br><span class="line">r = s.get(<span class="string">"http://httpbin.org/cookies"</span>)</span><br><span class="line"></span><br><span class="line">print(r.text)</span><br><span class="line"> <span class="comment">#'&#123;"cookies": &#123;"sessioncookie": "123456789"&#125;&#125;'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>SSL 证书验证<br>Requests 可以为 HTTPS 请求验证 SSL 证书，就像 web 浏览器一样。要想检查某个主机的 SSL 证书，可以使用 verify 参数:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">requests.get(<span class="string">'https://github.com'</span>, verify=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>代理<br>利用proxies 参数来配置请求 </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxies = &#123;</span><br><span class="line">  <span class="string">"http"</span>: <span class="string">"http://10.10.1.10:3128"</span>,</span><br><span class="line">  <span class="string">"https"</span>: <span class="string">"http://10.10.1.10:1080"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requests.get(<span class="string">"http://example.org"</span>, proxies=proxies)</span><br></pre></td></tr></table></figure>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://docs.python-requests.org/zh_CN/latest/user/quickstart.html" target="_blank" rel="noopener">requests quickstart</a></p>
<p><a href="http://docs.python-requests.org/zh_CN/latest/user/advanced.html" target="_blank" rel="noopener">requests advance </a></p>
<p><a href="http://liam0205.me/2016/02/27/The-requests-library-in-Python/" target="_blank" rel="noopener">Python HTTP 库：requests 快速入门</a></p>
<p><strong><em>本篇文章由<a href="https://zhangchenchen.github.io/">pekingzcc</a>采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可,转载请注明。</em></strong></p>
<p> <strong><em>END</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhangchenchen.github.io/2016/08/29/shell-set/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="pekingzcc">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Solar">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Solar" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/29/shell-set/" itemprop="url">
                  shell脚本系列--set 与 unset
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-29T14:24:25+08:00">
                2016-08-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/29/shell-set/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/29/shell-set/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录结构："><a href="#目录结构：" class="headerlink" title="目录结构："></a>目录结构：</h2><p><a href="#A">命令用途 </a></p>
<p><a href="#B">常用命令参数 </a></p>
<p><a href="#C">使用示例</a></p>
<p><a name="A"></a></p>
<h2 id="命令用途"><a href="#命令用途" class="headerlink" title="命令用途"></a>命令用途</h2><p>set 主要是显示系统中已经存在的shell变量，以及设置shell变量的新变量值。使用set更改shell特性时，符号”+”和”-“的作用分别是打开和关闭指定的模式。set命令不能够定义新的shell变量。如果要定义新的变量，可以使用declare命令以 变量名=值 的格式进行定义即可。</p>
<p>unset 用于删除已定义的shell变量（包括环境变量）和shell函数。unset命令不能够删除具有只读属性的shell变量和环境变量。</p>
<p><a name="B"></a></p>
<h2 id="常用命令参数"><a href="#常用命令参数" class="headerlink" title="常用命令参数"></a>常用命令参数</h2><p>set常用参数</p>
<ol>
<li><p>-a  标示已修改的变量，以供输出至环境变量。</p>
</li>
<li><p>-b 使被中止的后台程序立刻回报执行状态。</p>
</li>
</ol>
<p>unset 常用参数</p>
<ol>
<li><p>-f 仅删除函数</p>
</li>
<li><p>-v 仅删除变量</p>
</li>
</ol>
<p><a name="C"></a></p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>set 示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">declare</span> mylove=<span class="string">'Visual C++'</span> <span class="comment">#定义新环境变量</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -a mylove <span class="comment">#设置为环境变量</span></span><br><span class="line"></span><br><span class="line">env | grep mylove <span class="comment">#显示环境变量值</span></span><br></pre></td></tr></table></figure>
<p>unset 示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">unset</span> -v mylove <span class="comment">#删除指定的环境变量</span></span><br></pre></td></tr></table></figure>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://man.linuxde.net/unset" target="_blank" rel="noopener">Linux unset</a></p>
<p><a href="http://man.linuxde.net/set" target="_blank" rel="noopener">linux set </a></p>
<p><strong><em>本篇文章由<a href="https://zhangchenchen.github.io/">pekingzcc</a>采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可,转载请注明。</em></strong></p>
<p> <strong><em>END</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhangchenchen.github.io/2016/08/26/shell-declare-typeset/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="pekingzcc">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Solar">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Solar" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/26/shell-declare-typeset/" itemprop="url">
                  shell脚本系列--declare 与 typeset
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-26T09:24:25+08:00">
                2016-08-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/26/shell-declare-typeset/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/26/shell-declare-typeset/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录结构："><a href="#目录结构：" class="headerlink" title="目录结构："></a>目录结构：</h2><p><a href="#A">命令用途 </a></p>
<p><a href="#B">常用命令参数 </a></p>
<p><a href="#C">使用示例</a></p>
<p><a name="A"></a></p>
<h2 id="命令用途"><a href="#命令用途" class="headerlink" title="命令用途"></a>命令用途</h2><p>declare 与 typeset 命令是bash的内建命令，两者是完全一样的，用来声明shell变量，设置变量的属性。</p>
<p><a name="B"></a></p>
<h2 id="常用命令参数"><a href="#常用命令参数" class="headerlink" title="常用命令参数"></a>常用命令参数</h2><ol>
<li><p>-r  设置变量为只读</p>
</li>
<li><p>-i 设置变量为整数</p>
</li>
<li><p>-a 设置变量为数组array</p>
</li>
<li><p>-f 如果后面没有参数的话会列出之前脚本定义的所有函数，如果有参数的话列出以参数命名的函数</p>
</li>
<li><p>-x 设置变量在脚本外也可以访问到</p>
</li>
</ol>
<p><a name="C"></a></p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">func1 ()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">echo</span> This is a <span class="keyword">function</span>.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">declare</span> -f        <span class="comment"># Lists the function above.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">declare</span> -i var1   <span class="comment"># var1 is an integer.</span></span><br><span class="line">var1=2367</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"var1 declared as <span class="variable">$var1</span>"</span></span><br><span class="line">var1=var1+1       <span class="comment"># Integer declaration eliminates the need for 'let'.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"var1 incremented by 1 is <span class="variable">$var1</span>."</span></span><br><span class="line"><span class="comment"># Attempt to change variable declared as integer.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Attempting to change var1 to floating point value, 2367.1."</span></span><br><span class="line">var1=2367.1       <span class="comment"># Results in error message, with no change to variable.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"var1 is still <span class="variable">$var1</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">declare</span> -r var2=13.36         <span class="comment"># 'declare' permits setting a variable property</span></span><br><span class="line">                              <span class="comment">#+ and simultaneously assigning it a value.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"var2 declared as <span class="variable">$var2</span>"</span> <span class="comment"># Attempt to change readonly variable.</span></span><br><span class="line">var2=13.37                    <span class="comment"># Generates error message, and exit from script.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"var2 is still <span class="variable">$var2</span>"</span>    <span class="comment"># This line will not execute.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0                        <span class="comment"># Script will not exit here.</span></span><br></pre></td></tr></table></figure>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://tldp.org/LDP/abs/html/declareref.html" target="_blank" rel="noopener">Advanced Bash-Scripting Guide</a></p>
<p><a href="http://www.cnblogs.com/fhefh/archive/2011/04/22/2024857.html" target="_blank" rel="noopener">linux bash shell之declare </a></p>
<p><strong><em>本篇文章由<a href="https://zhangchenchen.github.io/">pekingzcc</a>采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可,转载请注明。</em></strong></p>
<p> <strong><em>END</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhangchenchen.github.io/2016/08/22/openstack-nova/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="pekingzcc">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Solar">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Solar" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/22/openstack-nova/" itemprop="url">
                  openstack系列--Nova
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-22T14:39:25+08:00">
                2016-08-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/22/openstack-nova/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/22/openstack-nova/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录结构："><a href="#目录结构：" class="headerlink" title="目录结构："></a>目录结构：</h2><p><a href="#A">概述 </a></p>
<p><a href="#B">体系架构 </a></p>
<p><a href="#C">VM实例的生命周期管理</a></p>
<p><a href="#D">动态迁移实例</a></p>
<p><a href="#E">代码结构与部署</a></p>
<p><a name="A"></a></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote>
<p>OpenStack Nova provides a cloud computing fabric controller, supporting a wide variety of virtualization technologies, including KVM, Xen, LXC, VMware, and more. In addition to its native API, it includes compatibility with the commonly encountered Amazon EC2 and S3 APIs.</p>
</blockquote>
<p>也就是说，Nova 是一个控制器，它支持利用各种虚拟化技术（KVM,XEN等）完成云计算平台的CPU,内存，硬盘的虚拟化。云中的实例instance生命周期的所有活动都是由Nova控制。Nova自身并没有提供任何虚拟化能力，它使用libvirt API来与被支持的Hypervisors交互。Nova 通过一个与Amazon Web Services（AWS）EC2 API，S3 API兼容的web services API来对外提供服务。</p>
<p><a name="B"></a></p>
<h2 id="体系架构"><a href="#体系架构" class="headerlink" title="体系架构"></a>体系架构</h2><p>首先放一张 Openstack 的整体概念结构图：</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160822openstack-concept-architeucture.jpg" alt="Conceptual Architecture"></p>
<p>第二张图是逻辑结构图(图是13年的，现在的Network Service已经变更为Neutron)</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160822openstack-architecture.jpg" alt="openstack architecture"></p>
<p>图中可以看出，Nova处于Openstack的一个核心位置，其他组件都为 Nova 提供支持，Glance 为 VM 提供 image ，Cinder 和 Swift 分别为 VM 提供块存储和对象存储，Neutron 为 VM 提供网络连接。</p>
<p>接下来一张就是Nova的架构图：</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160822-nova-architecture.png" alt="nova architecture"></p>
<p>这些组件以子服务（后台 deamon 进程）的形式运行。总的来说，nova的各个组件是以数据库和队列为中心进行通信的，下面对其中的几个组件做一个简单的介绍：</p>
<ul>
<li><p>nova-api: 接收和响应客户的 API 调用。 除了提供 OpenStack 自己的API，nova-api 还支持 Amazon EC2 API。</p>
</li>
<li><p>nova-scheduler: 虚机调度服务，负责决定在哪个计算节点上运行虚机 。</p>
</li>
<li><p>nova-compute: 管理虚机的核心服务，通过调用 Hypervisor API 实现虚机生命周期管理 。</p>
</li>
<li><p>Hypervisor: 计算节点上跑的虚拟化管理程序，虚机管理最底层的程序。 不同虚拟化技术提供自己的 Hypervisor。 常用的 Hypervisor 有 KVM，Xen， VMWare 等 。</p>
</li>
<li><p>nova-conductor: nova-compute 经常需要更新数据库，比如更新虚机的状态。 出于安全性和伸缩性的考虑，nova-compute 并不会直接访问数据库，而是将这个任务委托给 nova-conductor。</p>
</li>
<li><p>Database: Nova 会有一些数据需要存放到数据库中，一般使用 MySQL。 数据库安装在控制节点上。 Nova 使用命名为 “nova” 的数据库。</p>
<ul>
<li>Message Queue: 为解耦各个子服务，Nova 通过 Message Queue 作为子服务的信息中转站。OpenStack 默认是用 RabbitMQ 作为 Message Queue。</li>
</ul>
</li>
</ul>
<p><a name="C"></a></p>
<h2 id="VM实例的生命周期管理"><a href="#VM实例的生命周期管理" class="headerlink" title="VM实例的生命周期管理"></a>VM实例的生命周期管理</h2><p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160822-openstack-instance-lifetime.png" alt="VM实例的生命周期"></p>
<p>有的操作功能比较类似，也有各自的适用场景，简单介绍下上述几个重要的操作：</p>
<ul>
<li><p>常规操作： 常规操作中，Launch、Start、Reboot、Shut Off 和 Terminate 都很好理解。 下面几个操作重点回顾一下：</p>
<ul>
<li><p>Resize: 通过应用不同的 flavor 调整分配给 instance 的资源。</p>
</li>
<li><p>Lock/Unlock:  可以防止对 instance 的误操作。 </p>
</li>
<li><p>Pause/Suspend/Resume: 暂停当前 instance，并在以后恢复。 Pause 和 Suspend 的区别在于 Pause 将 instance 的运行状态保存在计算节点的内存中，而 Suspend 保存在磁盘上。 Pause 的优点是 Resume 的速度比 Suspend 快；缺点是如果计算节点重启，内存数据丢失，就无法 Resume 了，而 Suspend 则没有这个问题。</p>
</li>
<li><p>Snapshot:  备份 instance 到 Glance。产生的 image 可用于故障恢复，或者以此为模板部署新的 instance。 </p>
</li>
</ul>
</li>
<li><p>故障处理: 故障处理有两种场景：计划内和计划外。计划内是指提前安排时间窗口做的维护工作，比如服务器定期的微码升级，添加更换硬件等。 计划外是指发生了没有预料到的突发故障，比如强行关机造成 OS 系统文件损坏，服务器掉电，硬件故障等。</p>
<p>计划内故障处理:对于计划内的故障处理，可以在维护窗口中将 instance 迁移到其他计算节点。 涉及如下操作： </p>
<ul>
<li>Migrate: 将 instance 迁移到其他计算节点。 迁移之前，instance 会被 Shut Off，支持共享存储和非共享存储。 </li>
<li>Live Migrate： 与 Migrate 不同，Live Migrate 能不停机在线地迁移 instance，保证了业务的连续性。也支持共享存储和非共享存储（Block Migration）。</li>
<li>Shelve/Unshelve： Shelve 将 instance 保存到 Glance 上，之后可通过 Unshelve 重新部署。 Shelve 操作成功后，instance 会从原来的计算节点上删除。 Unshelve 会重新选择节点部署，可能不是原节点。</li>
</ul>
<p>计划外故障处理： 划外的故障按照影响的范围又分为两类：Instance 故障和计算节点故障 。</p>
<p>   Instance 故障:Instance 故障只限于某一个 instance 的操作系统层面，系统无法正常启动。 可以使用如下操作修复 instance。</p>
<ul>
<li><p>Rescue/Unrescue: 用指定的启动盘启动，进入 Rescue 模式，修复受损的系统盘。成功修复后，通过 Unrescue 正常启动 instance。 </p>
</li>
<li><p>Rebuild: 如果 Rescue 无法修复，则只能通过 Rebuild 从已有的备份恢复。Instance 的备份是通过 snapshot 创建的，所以需要有备份策略定期备份。 </p>
<p>计算节点故障: Instance 故障的影响范围局限在特定的instance，计算节点本身是正常工作的。如果计算节点发生故障，OpenStack 则无法与节点的 nova-compute 通信，其上运行的所有 instance 都会受到影响。这个时候，只能通过 Evacuate 操作在其他正常节点上重建 Instance。</p>
</li>
<li><p>Evacuate:  利用共享存储上 Instance 的镜像文件在其他计算节点上重建 Instance。 所以提前规划共享存储是关键。</p>
</li>
</ul>
</li>
</ul>
<p><a name="D"></a></p>
<h2 id="动态迁移实例"><a href="#动态迁移实例" class="headerlink" title="动态迁移实例"></a>动态迁移实例</h2><p><em>注意</em>：以下内容大多摘自<a href="https://www.ibm.com/developerworks/community/blogs/132cfa78-44b0-4376-85d0-d3096cd30d3f?sortby=0&amp;maxresults=15&amp;page=2&amp;lang=en" target="_blank" rel="noopener">每天五分钟玩转openstack</a>，强烈推荐，如果觉得TLDR,以下为部分节选。</p>
<p>接下来以一个instance 动态迁移的示例来看下Nova的具体执行流程。</p>
<p>Migrate 操作会先将 instance 停掉，也就是所谓的“冷迁移”。而 Live Migrate 是“热迁移”，也叫“在线迁移”，instance不会停机。</p>
<p>Live Migrate 分两种：</p>
<ul>
<li><p>源和目标节点没有共享存储，instance 在迁移的时候需要将其镜像文件从源节点传到目标节点，这叫做 Block Migration（块迁移）</p>
</li>
<li><p>源和目标节点共享存储，instance 的镜像文件不需要迁移，只需要将 instance 的状态迁移到目标节点。</p>
</li>
</ul>
<p>源和目标节点需要满足一些条件才能支持 Live Migration：</p>
<ul>
<li><p>源和目标节点的 CPU 类型要一致。</p>
</li>
<li><p>源和目标节点的 Libvirt 版本要一致。</p>
</li>
<li><p>源和目标节点能相互识别对方的主机名称，比如可以在 /etc/hosts 中加入对方的条目。</p>
</li>
<li><p>在源和目标节点的 /etc/nova/nova.conf 中指明在线迁移时使用 TCP 协议。</p>
</li>
<li><p>Instance 使用 config driver 保存其 metadata。在 Block Migration 过程中，该 config driver 也需要迁移到目标节点。由于目前 libvirt 只支持迁移 vfat 类型的 config driver，所以必须在 /etc/nova/nova.conf 中明确指明 launch instance 时创建 vfat 类型的 config driver。</p>
</li>
<li><p>源和目标节点的 Libvirt TCP 远程监听服务得打开</p>
</li>
</ul>
<p>接下来以非共享存储Block Migration 为例简述下Nova的工作流程：</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160823nova-process.jpg" alt="block migration"></p>
<ol>
<li><p>向 nova-api 发送请求：通过dashboard 发送live migrate消息，指定源节点，目标节点。</p>
</li>
<li><p>nova-api 发送消息:nova-api 向 Messaging（RabbitMQ）发送了一条消息：“Live Migrate 这个 Instance” 源代码在 /opt/stack/nova/nova/compute/api.py，方法是 live_migrate。</p>
</li>
<li><p>nova-compute 执行操作：</p>
<ul>
<li><p>目标节点执行迁移前的准备工作，首先将instance的数据迁移过来，主要包括镜像文件、虚拟网络等资源，日志在 devstack-controller:/opt/stack/logs/n-cpu.log。</p>
</li>
<li><p>源节点启动迁移操作，暂停 instance。</p>
</li>
<li><p>在目标节点上 Resume instance</p>
</li>
<li><p>在源节点上执行迁移的后处理工作，删除 instance。</p>
</li>
<li><p>在目标节点上执行迁移的后处理工作，创建 XML，在 Hypervisor 中定义 instance，使之下次能够正常启动。</p>
</li>
</ul>
</li>
</ol>
<p><a name="E"></a></p>
<h2 id="代码结构与部署"><a href="#代码结构与部署" class="headerlink" title="代码结构与部署"></a>代码结构与部署</h2><p> <em>未完待续</em></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://www.aboutyun.com/thread-6733-1-1.html" target="_blank" rel="noopener">大家谈OpenStack-Nova组件理解</a></p>
<p><a href="http://solinea.com/blog/openstack-grizzly-architecture-revisited" target="_blank" rel="noopener">OpenStack Grizzly Architecture </a></p>
<p><a href="http://www.openstack.cn/?p=392" target="_blank" rel="noopener">OpenStack Hacker养成指南</a></p>
<p><a href="https://www.ibm.com/developerworks/community/blogs/132cfa78-44b0-4376-85d0-d3096cd30d3f?sortby=0&amp;maxresults=15&amp;page=3&amp;lang=en" target="_blank" rel="noopener">每天5分钟玩转 OpenStack</a></p>
<p><a href="http://docs.openstack.org/mitaka/networking-guide/intro-os-networking-overview.html" target="_blank" rel="noopener">openstack doc</a></p>
<p><a href="https://www.amazon.cn/Open-Stack%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E8%8B%B1%E7%89%B9%E5%B0%94%E5%BC%80%E6%BA%90%E6%8A%80%E6%9C%AF%E4%B8%AD%E5%BF%83/dp/B00WG4WJ9I/ref=sr_1_1?ie=UTF8&amp;qid=1471599232&amp;sr=8-1&amp;keywords=openstack+%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener">openstack 设计与实现</a></p>
<p><strong><em>本篇文章由<a href="https://zhangchenchen.github.io/">pekingzcc</a>采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可,转载请注明。</em></strong></p>
<p> <strong><em>END</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhangchenchen.github.io/2016/08/22/openstack-neutron/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="pekingzcc">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Solar">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Solar" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/22/openstack-neutron/" itemprop="url">
                  openstack系列--neutron
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-22T14:36:25+08:00">
                2016-08-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/22/openstack-neutron/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/22/openstack-neutron/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a name="A"></a></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>In short，neutron就是openstack为实现云平台上networking as a service而开发的项目。可以简单地理解为网络部分的虚拟化由neutron实现。</p>
<p><a name="B"></a></p>
<h2 id="核心概念解释"><a href="#核心概念解释" class="headerlink" title="核心概念解释"></a>核心概念解释</h2><p> 1, Tenant networks</p>
<p> 首先解释下network,一个network就是一个二层独立广播域。<br> 由租户在project中创建的network.默认创建的network是完全独立的，不与其他project共享。neutron提供的tenant networks包括如下几种类型：</p>
<ul>
<li><p>Flat : 所有的虚拟机实例都在同一个network中，没有分隔策略,都在一个广播域。基本不用这种类型。</p>
</li>
<li><p>Vlan : 提供对Vlan的支持。 </p>
</li>
<li><p>GRE and VXLAN ：利用隧道技术封装二层协议帧在L3或L4传输，实现两个虚拟Vlan的二层联通。</p>
<p>2, Provider networks</p>
<p>由openstack administrator 创建的network，在数据中心中映射物理网络。通常的类型为flat或Vlan</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160819NetworkTypes.png" alt="Provider networks"></p>
<p>3, Subnet </p>
<p>subnet属于网络中的三层概念，指定一段IPV4或者IPV6地址并描述其相关的配置信息。它附加在一个二层network 上指明属于这个network的虚拟机可使用的IP范围。</p>
<p>4, Port</p>
<p>port 是一个设备的连接点，例如一台虚拟机的虚拟网卡。同时描述了相关的网络配置，例如该端口的MAC地址与IP地址。</p>
<p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160819neutron_core_entities.png" alt="部分核心概念"></p>
<p>5, <a href="https://ask.openstack.org/en/question/51388/whats-the-difference-between-flat-gre-and-vlan-neutron-network-types/" target="_blank" rel="noopener">Vlan VS Vxlan</a></p>
</li>
</ul>
<p><a name="C"></a></p>
<h2 id="neutron-提供的服务"><a href="#neutron-提供的服务" class="headerlink" title="neutron 提供的服务"></a>neutron 提供的服务</h2><p> 1, 基础的网络虚拟化（core service）<br>  上文提到的network，subnet等都是一些基础的网络虚拟化服务。 </p>
<p> 2, DHCP 服务， 路由服务<br>  这两个服务 都需要network namespace 技术来实现。</p>
<p> 3, 安全组服务<br>  通过 Linux Iptables实现。</p>
<p> 4, LBaas<br>  它允许租户动态的在自己的网络创建一个负载均衡设备。</p>
<p> 5, FWaas<br>  防火墙一般放在网关上，用来隔离子网之间的访问。因此，防火墙即服务（FireWall as a Service）也是在网络节点上（具体说来是在路由器命名空间中）来实现。<br>  目前，OpenStack 中实现防火墙还是基于 Linux 系统自带的 iptables，所以大家对于其性能和功能就不要抱太大的期望了。<br>  一个可能混淆的概念是安全组（Security Group），安全组的对象是虚拟网卡，由L2 Agent来实现，比如neutron_openvswitch_agent 和 neutron_linuxbridge_agent，会在计算节点上通过配置 iptables 规则来限制虚拟网卡的进出访问。防火墙可以在安全组之前隔离外部过来的恶意流量，但是对于同个子网内部不同虚拟网卡间的通讯不能过滤（除非它要跨子网）。<br>  可以同时部署防火墙和安全组实现双重防护。</p>
<p> 6, DVR(分布式路由)<br>  按照 Neutron 原先的设计，所有网络服务都在网络节点上进行，这意味着大量的流量和处理，给网络节点带来了很大的压力。<br>  这些处理的核心是路由器服务。任何需要跨子网的访问都需要路由器进行路由。<br>  很自然，能否让计算节点上也运行路由器服务？这个设计思路无疑是更为合理的，但具体实施起来需要诸多细节上的技术考量。<br>  为了降低网络节点的负载，同时提高可扩展性，OpenStack 自 Juno 版本开始正式引入了分布式路由（Distributed Virtual Router，DVR）特性（用户可以选择使用与否），来让计算节点自己来处理原先的大量东西向流量和非 SNAT  南北流量（有 floating IP 的 vm 跟外面的通信）。<br>  这样网络节点只需要处理占到一部分的 SNAT （无 floating IP 的 vm 跟外面的通信）流量，大大降低了负载和整个系统对网络节点的依赖。很自然的，FWaaS 也可以跟着放到计算节点上。<br>  DHCP 服务、VPN 服务目前仍然需要集中在网络节点上进行。</p>
<p> 7, VPNaas</p>
<p><a name="D"></a></p>
<h2 id="架构与原理"><a href="#架构与原理" class="headerlink" title="架构与原理"></a>架构与原理</h2><p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160819-NEUTRON-ARCHITECTURE.png" alt="neutron架构图"></p>
<p>Neutron，其实和其他的OpenStack组件差不多，他都是一个中间层，自己基本不干具体的活，通过插件的机制，调用第三方的组件来完成相关的功能。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://abregman.com/2016/01/04/openstack-neutron-introduction/" target="_blank" rel="noopener">Openstack Neutron: Introduction</a></p>
<p><a href="http://www.chenshake.com/openstack-superficial-understanding-of-neutron-network/" target="_blank" rel="noopener">OpenStack Neutron网络的肤浅理解</a></p>
<p><a href="http://docs.openstack.org/mitaka/networking-guide/intro-os-networking-overview.html#openstack-networking-concepts" target="_blank" rel="noopener">Overview and components</a></p>
<p><a href="https://www.gitbook.com/book/yeasy/openstack_understand_neutron/details" target="_blank" rel="noopener">深入理解Neutron – OpenStack 网络实现</a></p>
<p><a href="http://docs.openstack.org/mitaka/networking-guide/intro-os-networking-overview.html" target="_blank" rel="noopener">openstack doc</a></p>
<p><a href="https://www.amazon.cn/Open-Stack%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0-%E8%8B%B1%E7%89%B9%E5%B0%94%E5%BC%80%E6%BA%90%E6%8A%80%E6%9C%AF%E4%B8%AD%E5%BF%83/dp/B00WG4WJ9I/ref=sr_1_1?ie=UTF8&amp;qid=1471599232&amp;sr=8-1&amp;keywords=openstack+%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener">openstack 设计与实现</a></p>
<p><strong><em>本篇文章由<a href="https://zhangchenchen.github.io/">pekingzcc</a>采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可,转载请注明。</em></strong></p>
<p> <strong><em>END</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhangchenchen.github.io/2016/08/22/openstack-technology-stack/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="pekingzcc">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Solar">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Solar" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/22/openstack-technology-stack/" itemprop="url">
                  openstack系列--Openstack 技术栈总览
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-22T11:06:25+08:00">
                2016-08-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/08/22/openstack-technology-stack/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/22/openstack-technology-stack/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://7xrnwq.com1.z0.glb.clouddn.com/20160822Openstack%E6%8A%80%E6%9C%AF%E6%A0%88.jpg" alt="Openstack 技术栈总览"></p>
<p><strong><em>本篇文章由<a href="https://zhangchenchen.github.io/">pekingzcc</a>采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可,转载请注明。</em></strong></p>
<p> <strong><em>END</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="pekingzcc" />
          <p class="site-author-name" itemprop="name">pekingzcc</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">97</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">45</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zhangchenchen" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">pekingzcc</span>
</div>


<div class="powered-by">
  powered by <a class="theme-link" href="https://hexo.io">Hexo</a> 
</div>

<div class="theme-info">
  theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'pekingzcc';
      var disqus_identifier = 'page/9/index.html';

      var disqus_title = "";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      

    </script>
  









  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


</body>
</html>
